<!DOCTYPE html>
<html>
<head>
  <title>Light Spectrum Analyzer</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    canvas { border: 1px solid #ccc; margin-top: 20px; }
  </style>
</head>
<body>
  <h2>Light Spectrum Analyzer</h2>
  <input type="file" accept="image/*" onchange="loadImage(event)">
  <canvas id="inputCanvas" width="600" height="200"></canvas>
  <canvas id="chartCanvas"></canvas>
  <p id="peakInfo"></p>

  <script>
    const canvas = document.getElementById("inputCanvas");
    const ctx = canvas.getContext("2d");
    const chartCtx = document.getElementById("chartCanvas").getContext("2d");
    let chart;

    function loadImage(event) {
      const img = new Image();
      img.onload = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        analyzeSpectrum();
      };
      img.src = URL.createObjectURL(event.target.files[0]);
    }

    function estimateWavelength(r, g, b) {
      if (b > r && b > g) return 470; // Blue
      if (g > r && g > b) return 530; // Green
      if (r > g && r > b) return 650; // Red
      return 500; // Default to greenish
    }

    function analyzeSpectrum() {
      const width = canvas.width;
      const y = Math.floor(canvas.height / 2);
      const data = [];
      let maxIntensity = 0;

      for (let x = 0; x < width; x += 2) {
        const pixel = ctx.getImageData(x, y, 1, 1).data;
        const r = pixel[0], g = pixel[1], b = pixel[2];
        const intensity = (r + g + b) / 3;
        if (intensity > maxIntensity) maxIntensity = intensity;
        const wavelength = estimateWavelength(r, g, b);
        data.push({ wavelength, intensity });
      }

      // Calculate absorbance and group by wavelength
      const absorbance = {};
      data.forEach(d => {
        const A = -Math.log10(d.intensity / maxIntensity + 0.001);
        absorbance[d.wavelength] = (absorbance[d.wavelength] || 0) + A;
      });

      const labels = Object.keys(absorbance).sort((a, b) => a - b);
      const values = labels.map(w => absorbance[w]);

      // Find peak
      const peakIndex = values.indexOf(Math.max(...values));
      const peakWavelength = labels[peakIndex];
      const peakAbsorbance = values[peakIndex].toFixed(2);

      document.getElementById("peakInfo").innerText = 
        `Peak Wavelength: ${peakWavelength} nm | Absorbance: ${peakAbsorbance}`;

      // Plot
      if (chart) chart.destroy();
      chart = new Chart(chartCtx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Absorbance Spectrum',
            data: values,
            borderColor: 'blue',
            fill: false
          }]
        },
        options: {
          scales: {
            x: { title: { display: true, text: 'Wavelength (nm)' } },
            y: { title: { display: true, text: 'Absorbance' } }
          }
        }
      });
    }
  </script>
</body>
</html>
